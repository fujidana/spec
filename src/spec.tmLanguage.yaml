$schema: https://raw.githubusercontent.com/martinring/tmlanguage/master/tmlanguage.json
name: spec
scopeName: source.spec
patterns:
  - include: "#statement"
repository:
  statement:
    patterns:
      - match: \s+
      - match: ;
        name: punctuation.statement.separator.spec
      - include: "#comment"
      - include: "#docstring"
      - include: "#code-block"
      - include: "#control"
      - include: "#declaration"
      - include: "#builtin-macro"
      - include: "#expression-statement"
    repository:
      code-block:
        begin: \{
        beginCaptures:
          "0": { name: punctuation.code-block.begin.spec }
        end: \}
        endCaptures:
          "0": { name: punctuation.code-block.end.spec }
        name: meta.code-block.spec
        patterns: [{ include: "#statement" }]
      control:
        patterns:
          - begin: \b(if)\s*(\()
            beginCaptures:
              "1": { name: keyword.control.branch.spec }
              "2": { name: punctuation.branch-condition.begin.spec }
            end: \)
            endCaptures:
              "0": { name: punctuation.branch-condition.end.spec }
            contentName: meta.branch-condition.spec
            patterns: [{ include: "#expression-single" }]
          - match: \belse\b
            name: keyword.control.branch.spec
          - begin: \b(for)\s*(\()
            beginCaptures:
              "1": { name: keyword.control.flow.spec }
              "2": { name: punctuation.flow-condition.begin.spec }
            end: \)
            endCaptures:
              "0": { name: punctuation.flow-condition.end.spec }
            contentName: meta.flow-condition.spec
            patterns: [{ include: "#for-condition" }]
          - begin: \b(while)\s*(\()
            beginCaptures:
              "1": { name: keyword.control.flow.spec }
              "2": { name: punctuation.flow-condition.begin.spec }
            end: \)
            endCaptures:
              "0": { name: punctuation.flow-condition.end.spec }
            contentName: meta.flow-condition.spec
            patterns: [{ include: "#expression-single" }]
          - match: \b(break|continue|exit)\s*(?=$|;|#|"""|}|')
            captures:
              "1": { name: keyword.control.transfer.spec }
          - begin: \b(return)\b\s*
            beginCaptures: 
              "1": { name: keyword.control.transfer.spec }
            end: (?=$|;|#|"""|}|')
            patterns: [{ include: "#expression-single" }]
        repository:
          for-condition:
            patterns:
              - include: "#expression-multiple"
              - match: ;
                name: punctuation.flow-condition.separator.spec
            # - match: (?:(.+)\s+(in)\s+(.+))\s*(?=\))
            #   captures:
            # - match: .*?\s*(?=\))
            #   name: invalid.illegal.for-condition.spec
      declaration:
        patterns:
          - ### usage: def <identifier> ' <statement> ';
            ### usage: def <identifier> ([<arg>...])'{ <statement> }';
            begin: (def)\s+(\w+)(?:\s*(\()([^'"#)]*)(\)))?\s*(')
            beginCaptures:
              "1": { name: storage.type.macro.spec }
              "2":
                {
                  name: entity.name.function.spec,
                  patterns: [{ include: "#validation-id" }],
                }
              "3": { name: punctuation.function-argument.begin.spec }
              "4": { patterns: [{ include: "#list-id" }] }
              "5": { name: punctuation.function-argument.end.spec }
              "6": { name: punctuation.function-body.begin.spec }
            end: (')\s*(.*?)(?=$|;|#|"""|}|')
            endCaptures:
              "1": { name: punctuation.function-body.end.spec }
              "2": { name: invalid.illegal.syntax.spec }
            contentName: meta.function-body.spec
            patterns: [{ include: "#statement" }]
          - ### usage: rdef <identifier> <expression>;
            begin: \b(rdef)\s+(\w+)\s+
            beginCaptures:
              "1": { name: storage.type.macro.spec }
              "2":
                {
                  name: entity.name.function.spec,
                  patterns: [{ include: "#validation-id" }],
                }
            end: (?=$|;|#|"""|}|')
            patterns: [{ include: "#expression-single" }]
          - ### usage: undef <identifier>[(,| )<identifier>...];
            match: \b(undef)\s+(\w.*)\s*(?=$|;|#|"""|}|')
            captures:
              "1": { name: storage.type.macro.spec }
              "2": { patterns: [{ include: "#list-function-id" }] }
          - ### usage: (local|global|shared)? (<type>)? array <identifier>\[<expression>\]\[<expression>\];
            match: \b(?:(local|global|shared)\s+)?(?:(float|double|string|u?(?:byte|short|long(?:64)?))\s+)?(array)\s+(\S.*?)(?=$|;|#|"""|}|')
            captures:
              "1": { name: storage.modifier.array.spec }
              "2": { name: storage.type.data-array.spec }
              "3": { name: storage.type.data-array.spec }
              "4": { patterns: [{ include: "#list-array" }] }
          - ### usage: extern shared array <spec-identifier>:<id-number>:<array-identifier>;
            match: \b(extern)\s+(shared)\s+(array)\s+(\S.*?)(?=$|;|#|"""|}|')
            captures:
              "1": { name: storage.modifier.array.spec }
              "2": { name: storage.modifier.array.spec }
              "3": { name: storage.type.data-array.spec }
              "4": { patterns: [{ include: "#list-extern-array"}] }
          - ### usage: constant identifier [=] expression
            begin: \b(constant)\s+(\S+)(?:\s*(=)\s*|\s+)
            beginCaptures:
              "1": { name: storage.modifier.constant.spec }
              "2":
                {
                  name: entity.other.constant.spec,
                  patterns: [{ include: "#validation-id" }],
                }
              "3": { name: keyword.operator.arithmetic.assignment.spec }
            end: (?=$|;|#|"""|}|')
            patterns: [{ include: "#expression-single" }]
          - ### (local|global|unglobal) <identifier-list>
            match: \b(local|global|unglobal)\s+(\S.*?)(?=$|;|#|"""|}|')
            captures:
              "1": { name: storage.modifier.variable.spec }
              "2": { patterns: [{ include: "#list-arrayable-id" }] }
          - ### delete <assoc-elem-list>; delete <accos-array>
            match: \b(delete)\s+(\S.*?)(?=$|;|#|"""|}|')
            captures:
              "1": { name: support.function.built-in.macro.spec }
              "2": { patterns: [{ include: "#list-array" }] }
      builtin-macro:
        patterns:
          - ### usage: (memstat|savstate|reconfig|getcounts|move_all|move_cnt|sync)
            match: \b(memstat|savstate|reconfig|getcounts|move_(?:all|cnt)|sync)\s*(?=$|;|#|"""|}|')
            captures:
              "1": { name: support.function.built-in.macro.spec }
          - ### usage: (lscmd|lsdef|prdef|syms) [<pattern> ...]
            match: \b(ls(?:cmd|def)|prdef|syms)(?:\s*|\s+(.+?))(?=$|;|#|"""|}|')
            captures:
              "1": { name: support.function.built-in.macro.spec }
              "2": { patterns: [{ include: "#list-pattern" }] }
          - ### usage: (print|eprint) <expression-list>
            begin: \b(print|eprint)\b
            beginCaptures:
              "1": { name: support.function.built-in.macro.spec }
            end: (?=$|;|#|"""|}|')
            patterns: [{ include: "#expression-multiple" }]
          - ### usage: (history) N?
            begin: \b(history)\b
            beginCaptures:
              "1": { name: support.function.built-in.macro.spec }
            end: (?=$|;|#|"""|}|')
            patterns: [{ include: "#expression-single" }]
      expression-statement:
        patterns:
          - begin: (?=.)
            end: (?=$|;|#|"""|'|}|')
            patterns: [{ include: "#expression-multiple" }]
  expression-multiple:
    patterns:
      - include: "#expression-single"
      - match: ","
        name: "punctuation.expression-separator"
  expression-single:
    patterns:
      - include: "#expression-block"
      - include: "#operator"
      - include: "#function-call"
      - include: "#lvalue"
      - include: "#literal-numeric"
      - include: "#literal-string"
      - include: "#comment"
      - include: "#docstring"
      - include: "#invalid-word"
      - include: "#array-access"
    repository:
      function-call: ### No spacing is allowed before the opening parenthesis.
        begin: \b([a-zA-Z_][a-zA-Z0-9_]*)(\()
        beginCaptures:
          "1":
            patterns:
              - match: \b(?:chdir|get(?:env|help|val|sval|line)|time|unix|date|file_info|whatis|calc|eval2?|spec_(?:par|menu)|sleep|open|close|on|off|dofile|qdofile|input|yesno|printf|eprintf|fprintf|tty_(?:cntl|move|fmt)|cdef|clone|strdef|exp(?:10)?|log(?:10)?|pow|srand|rand|sqrt|int|fabs|cos|sin|tan|a(?:cos|sin|tan|tan2)|index|split|sub(?:str)?|length|sprintf|sscanf|rsplit|gsub|gensub|match|asc|bcd|dcb|deg|rad|array_(?:dump|read|pipe|plot|copy|op|fit)|plot_(?:cntl|move|range)|splot_cntl|fmt_(?:read|write|close)|h5_(?:attr|file|link|data)|prop_(?:send|watch|get|put)|remote_(?:cmd|eval|async|poll|stat|par)|encode|decode|data_(?:grp|info|nput|get|dump|read|pipe|plot|put|fit|uop|bop|anal)|motor_(?:mne|name|num|par)|read_motors|dial|chg_dial|get_lim|move_info|user|chg_offset|set_lim|mcount|tcount|cnt_(?:mne|name|num)|counter_par|set_sim|wait|stop|mca_(?:par|get|put|sel|spar|sget|sput)|image_(?:par|get|put)|taco_(?:io|db|dc)|tango_(?:io|get|put|db)|epics_(?:par|get|put)|em_io|sock_(?:par|get|put)|ser_(?:par|get|put)|gpib_(?:par|get|put|poll|cntl)|vme_(?:move|get(?:32)?|put(?:32)?)|port_(?:getw?|putw?)|vxi11_(?:par|get|put)|fbus_(?:get|put)|ca_(?:cntl|get|put|fna))\b
                name: support.function.built-in.function.spec
              - match: .+
                name: entity.name.function.spec
                captures:
                  "0": { patterns: [{ include: "#validation-id" }] }
          "2": { name: punctuation.definition.arguments.begin.spec }
        end: \)
        endCaptures:
          "0": { name: punctuation.definition.arguments.end.spec }
        contentName: meta.function-argument.spec
        patterns: [{ include: "#expression-single" }]
      lvalue:
        patterns:
          - match: \b(PI)\b
            name: support.constant.spec
          - match: \b(OUTFILES|CCDS|COUNTERS|CWD|DISPLAY|EVAL_(ERR|RESULT)|FRESH|GETLINE_EOF|HOME|HOSTNAME|IS_SERVER|MCAS|MOTORS|SPECD?|USER|VERSION)\b
            name: support.variable.readonly.spec
          - match: \b(A|S|DEBUG|HDW_ERR|DISPLAY|TERM|GTERM|ROWS|COLS)\b
            name: support.variable.readwrite.spec
          - match: \$(#|\*|[0-9]+) # max 25 arguments
            name: variable.other.spec
          - match: \b([a-zA-Z_][a-zA-Z0-9_]*)\b
            name: entity.other.variable.spec
            captures:
              "0": { patterns: [{ include: "#validation-id" }] }
      literal-numeric:
        patterns:
          - match: \b(?<!\.)(0[xX])[0-9a-fA-F]+(?![\.\w])
            name: constant.numeric.integer.hexadecimal.spec
            captures:
              "1": { name: keyword.other.integer.hexadecimal.spec }
          - match: \b(?<!\.)(0)[0-7]+(?![\.\w])
            name: constant.numeric.integer.octal.spec
            captures:
              "1": { name: keyword.other.integer.otcal.spec }
          - match: \b(?<!\.)(0|[1-9][0-9]*)(?![\.\w])
            name: constant.numeric.integer.decimal.spec
          - match: \b(?<!\.)[0-9]+(?:\.[0-9]*)?(?:(e|E)[+-]?[0-9]+)?(?![\.\w])
            name: constant.numeric.float.spec
            captures:
              "1": { name: keyword.other.float.scientific-notation.spec }
          - match: (?<!\w)\.[0-9]+(?:(e|E)[+-]?[0-9]+)?(?![\.\w])
            name: constant.numeric.float.spec
            captures:
              "1": { name: keyword.other.float.scientific-notation.spec }
          - match: \b[0-9][\w.]*
            name: invalid.illegal.numeric.other.spec
      literal-string:
        patterns:
          - begin: \\'
            beginCaptures:
              "0": { name: punctuation.string.begin.spec }
            end: \\'
            endCaptures:
              "0": { name: punctuation.string.end.spec }
            name: string.quoted.single.spec
            patterns:
              - match: \\([abfnrt"\\]|[0-7]{1,3}|\[(?:c(?:d|e)|do|ho|le|m(?:b|d|e|h|r)|nd|se|u(?:e|p|s))\])
                name: constant.character.escape.spec
              - match: \\.
                name: invalid.illegal.unknown-escape.spec
          - begin: '"'
            beginCaptures:
              "0": { name: punctuation.string.begin.spec }
            end: '"'
            endCaptures:
              "0": { name: punctuation.string.end.spec }
            name: string.quoted.double.spec
            patterns:
              - match: \\([abfnrt'"\\]|[0-7]{1,3}|\[(?:c(?:d|e)|do|ho|le|m(?:b|d|e|h|r)|nd|se|u(?:e|p|s))\])
                name: constant.character.escape.spec
              - match: \\.
                name: invalid.illegal.unknown-escape.spec
      expression-block:
        begin: \(
        beginCaptures:
          "0": { name: punctuation.expression-block.begin.spec }
        end: \)
        endCaptures:
          "0": { name: punctuation.expression-block.end.spec }
        name: meta.expression-block.spec
        patterns: [{ include: "#expression-single" }]
      operator:
        patterns:
          - match: \b(in)\b
            name: keyword.operator.binary.access-array-item.spec
          - match: --|\+\+
            name: keyword.operator.unary.arithmetic.increment-decrement.spec
          - match: <<=|>>=|\^=|&=|\|=
            name: keyword.operator.assignment.bitwise.spec
          - match: <<|>>
            name: keyword.operator.binary.bitwise.shift.spec
          - match: ==|!=|<=|>=|<|>
            name: keyword.operator.binary.arithmetic.comparison.spec
          - match: \+=|−=|\*=|/=|%=|=
            name: keyword.operator.assignment.arithmetic.spec
          - match: \|\||&&
            name: keyword.operator.binary.logical.and-or.spec
          - match: \*|/|-|\+|%
            name: keyword.operator.binary.arithmetic.four-operations.spec
          - match: \||&|\^
            name: keyword.operator.binary.bitwise.logical.spec
          - match: "!"
            name: keyword.operator.unary.logical.not.spec
          - match: \~
            name: keyword.operator.unary.bitwise.not.spec
          - match: (@)([a-zA-Z_][a-zA-Z0-9_]*)\b
            captures:
              "1": { name: keyword.operator.indirection.spec }
              "2":
                {
                  name: variable.other.spec,
                  patterns: [{ include: "#validation-id" }],
                }
      array-access:
        patterns:
          - begin: \[
            beginCaptures:
              "0": { name: punctuation.array.left.spec }
            end: \]
            endCaptures:
              "0": { name: punctuation.array.right.spec }
            name: meta.array.spec
            patterns: [{ include: "#expression-single" }]
      invalid-word:
        patterns:
          - match: \{
            name: invalid.illegal.not-used-in-expression.spec
  comment:
    match: (#).*$
    name: comment.line.number-sign.spec
    captures:
      "1": { name: punctuation.comment.line.spec }
  docstring:
    begin: '"""'
    beginCaptures:
      "0": { name: punctuation.comment.docstring.begin.spec }
    end: '"""'
    endCaptures:
      "0": { name: punctuation.comment.docstring.end.spec }
    name: comment.block.documentation.spec #string.quoted.triple.spec
  list-id:
    match: ([^,\s]+?)(?:\s*(,)\s*|\s+|$)
    captures:
      "1":
        {
          name: entity.other.variable.spec,
          patterns: [{ include: "#validation-id" }],
        }
      "2": { name: punctuation.id-separator.spec }
  list-arrayable-id:
    match: ([^,\s]+?)(?:(\[\s*)(\])){0,2}(?:\s*(,)\s*|\s+|$)
    captures:
      "1":
        {
          name: entity.other.variable.spec,
          patterns: [{ include: "#validation-id" }],
        }
      "2": { name: punctuation.array.left.spec }
      "3": { name: punctuation.array.right.spec }
      "4": { name: punctuation.id-separator.spec }
  list-function-id:
    match: ([^,\s]+?)(?:\s*(,)\s*|\s+|$)
    captures:
      "1":
        {
          name: entity.name.function.spec,
          patterns: [{ include: "#validation-id" }],
        }
      "2": { name: punctuation.id-separator.spec }
  list-array: # e.g., arr_a[(2+3)], arr_b["abc"]["def"]
    patterns:
      - begin: ([^,\s]+?)\s*(?=\[)(?!\[\s*\])
        beginCaptures:
          "1":
            {
              name: entity.other.array.spec,
              patterns: [{ include: "#validation-id" }],
            }
        end: (?<=\])(?:\s*(,)\s*|\s+|$)
        endCaptures:
          "1": { name: punctuation.list.separator.spec }
        patterns: [{ include: "#expression-single" }]
      - match: (\w+)(?:\s*(,)\s*|\s+|$)
        patterns: [{ include: "#validation-id" }]
  list-extern-array: # e.g., spec:0:arr0, spec:arr1, arr2
    match: (?:(\w+?)(:)(?:(\d+)(:))?)?(\w+)(?:\s*(,)\s*|\s+|$)
    captures:
      "1": { name: entity.other.process-version.spec }
      "2": { name: punctuation.extern.separator.spec }
      "3": { name: entity.other.process-id.spec }
      "4": { name: punctuation.extern.separator.spec }
      "5":
        {
          name: entity.other.array.spec,
          patterns: [{ include: "#validation-id" }],
        }
      "6": { name: punctuation.id-separator.spec }
  list-pattern: # comma is not allowed as the seprator
    match: (\S+)(\s|$)
    captures:
      "1":
        {
          name: entity.name.pattern.spec,
          patterns: [{ include: "#validation-pattern" }],
        }
      # '2': {name: punctuation.pattern-separator.spec}
  validation-id:
    patterns:
      - match: "\\b(\
          def|rdef|undef|constant|local|global|unglobal|\
          shared|extern|float|double|string|u?(?:byte|short|long(?:64)?)|array|delete|\
          if|else|while|for|in|break|continue|exit|return|quit|\
          memstat|savstate|reconfig|getcounts|move_(?:all|cnt)|sync|ls(?:cmd|def)|prdef|syms|print|eprint|history|\
          chdir|get(?:env|help|val|sval|line)|time|unix|date|file_info|whatis|calc|eval2?|spec_(?:par|menu)|sleep|open|close|on|off|dofile|qdofile|input|yesno|printf|eprintf|fprintf|tty_(?:cntl|move|fmt)|cdef|clone|strdef|exp(?:10)?|log(?:10)?|pow|srand|rand|sqrt|int|fabs|cos|sin|tan|a(?:cos|sin|tan|tan2)|index|split|sub(?:str)?|length|sprintf|sscanf|rsplit|gsub|gensub|match|asc|bcd|dcb|deg|rad|array_(?:dump|read|pipe|plot|copy|op|fit)|plot_(?:cntl|move|range)|splot_cntl|fmt_(?:read|write|close)|h5_(?:attr|file|link|data)|prop_(?:send|watch|get|put)|remote_(?:cmd|eval|async|poll|stat|par)|encode|decode|data_(?:grp|info|nput|get|dump|read|pipe|plot|put|fit|uop|bop|anal)|motor_(?:mne|name|num|par)|read_motors|dial|chg_dial|get_lim|move_info|user|chg_offset|set_lim|mcount|tcount|cnt_(?:mne|name|num)|counter_par|set_sim|wait|stop|mca_(?:par|get|put|sel|spar|sget|sput)|image_(?:par|get|put)|taco_(?:io|db|dc)|tango_(?:io|get|put|db)|epics_(?:par|get|put)|em_io|sock_(?:par|get|put)|ser_(?:par|get|put)|gpib_(?:par|get|put|poll|cntl)|vme_(?:move|get(?:32)?|put(?:32)?)|port_(?:getw?|putw?)|vxi11_(?:par|get|put)|fbus_(?:get|put)|ca_(?:cntl|get|put|fna)|\
          PI|\
          OUTFILES|CCDS|COUNTERS|CWD|DISPLAY|EVAL_(ERR|RESULT)|FRESH|GETLINE_EOF|HOME|HOSTNAME|IS_SERVER|MCAS|MOTORS|SPECD?|USER|VERSION|\
          A|S|DEBUG|HDW_ERR|DISPLAY|TERM|GTERM|ROWS|COLS\
          )\\b"
        name: invalid.illegal.reserved-identifier.spec
      - match: '[a-zA-Z_][a-zA-Z0-9_]*\Z'
      - match: .*
        name: invalid.illegal.invalid-identifier.spec
  validation-pattern:
    patterns:
      - match: '[a-zA-Z0-9_?*]+\Z'
      - match: .*
        name: invalid.illegel.invalid-pattern.spec
